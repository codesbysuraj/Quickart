<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Settings - QuickKart</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dfwsy9yak/image/upload/v1759119566/title-logo_ward5i.png">
    <link rel="stylesheet" href="style.css">
    <style>
      body { background: none; }
      .settings-container {
        max-width: 900px;
        margin: 3rem auto;
        background: #fff;
        border-radius: 16px;
        padding: 2.5rem 2rem;
        box-shadow: 0 2px 12px rgba(244,99,3,0.08);
      }
      .settings-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }
      .settings-header h1 {
        color: #f46303;
        font-size: 2.1rem;
        margin-bottom: 0.5rem;
      }
      .settings-header p {
        color: #666;
        font-size: 1rem;
      }
      .settings-section {
        background: #fff;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        padding: 1.8rem 1.5rem;
        margin-bottom: 1.5rem;
        transition: border-color 0.2s;
      }
      .settings-section:hover {
        border-color: #f46303;
      }
      .section-title {
        color: #f46303;
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .section-title::before {
        content: '‚óè';
        font-size: 0.8rem;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.2rem;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 0.7rem 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1rem;
        background: #fff6f2;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #f46303;
        box-shadow: 0 0 0 3px rgba(244,99,3,0.1);
      }
      .form-group input:disabled {
        background: #f5f5f5;
        color: #999;
        cursor: not-allowed;
      }
      .readonly-info {
        background: #f9f9f9;
        padding: 0.7rem 1rem;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        color: #666;
        font-size: 1rem;
      }
      .save-btn {
        background: #f46303;
        color: white;
        border: none;
        padding: 0.8rem 2.5rem;
        border-radius: 24px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(244, 99, 3, 0.10);
        transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
        letter-spacing: 0.5px;
        margin-right: 1rem;
      }
      .save-btn:hover {
        background: #d84315;
        box-shadow: 0 6px 24px rgba(244, 99, 3, 0.18);
        transform: translateY(-2px) scale(1.04);
      }
      .cancel-btn {
        background: #f0f0f0;
        color: #333;
        border: none;
        border-radius: 24px;
        padding: 0.8rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .cancel-btn:hover {
        background: #e0e0e0;
      }
      .form-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #f0f0f0;
      }
      .success-msg {
        background: #d4edda;
        color: #155724;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #c3e6cb;
        font-weight: 600;
        display: none;
      }
      .error-msg {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #f5c6cb;
        font-weight: 600;
        display: none;
      }
      .info-badge {
        display: inline-block;
        background: #f46303;
        color: white;
        padding: 0.2rem 0.8rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .helper-text {
        font-size: 0.85rem;
        color: #888;
        margin-top: 0.3rem;
      }
      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
        .settings-container {
          margin: 1rem;
          padding: 1.5rem 1rem;
        }
      }
    </style>
</head>
<body>
  <header class="navbar">
    <div class="logo">
      <a href="index.html">
        <img src="https://res.cloudinary.com/dfwsy9yak/image/upload/v1759119568/logo_qbsfps.png" alt="QuickKart Logo">
      </a>
    </div>
    <div class="search-bar">
      <img style="height: 40px;border-top-left-radius:10px;border-bottom-left-radius:10px;" src="https://res.cloudinary.com/dfwsy9yak/image/upload/v1759170467/search-icon_eufwtm.png" alt="search icon"/>
      <input type="text" id="searchInput" placeholder="Search for products..." onkeypress="if(event.key==='Enter') performSearch()" />
      <button class="search-btn" onclick="performSearch()">Search</button>
    </div>
    <div class="nav-buttons">
      <a id="homeBtn" href="index.html" class="nav-link-button">Back to Shopping</a>
      <div class="account-menu" id="accountMenu">
        <button onclick="toggleAccount()">My Account</button>
        <div class="account-dropdown" id="accountDropdown">
          <a href="order-history.html">Order History</a>
          <a href="address-details.html">Address Book</a>
          <a href="user-settings.html">User Settings</a>
          <button type="button" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <div class="settings-container">
    <div class="settings-header">
      <h1>User Settings</h1>
      <p>Manage your account information and preferences</p>
    </div>

    <div id="successMsg" class="success-msg"></div>
    <div id="errorMsg" class="error-msg"></div>

    <form id="settingsForm">
      <!-- Account Information Section -->
      <div class="settings-section">
        <div class="section-title">Account Information</div>
        <div class="form-row">
          <div class="form-group">
            <label>Username</label>
            <div class="readonly-info" id="displayUsername">Loading...</div>
            <div class="helper-text">Username cannot be changed</div>
          </div>
          <div class="form-group">
            <label>Account Type <span class="info-badge" id="rolebadge">USER</span></label>
            <div class="readonly-info" id="displayRole">Loading...</div>
            <div class="helper-text">Your account role</div>
          </div>
        </div>
      </div>

      <!-- Personal Information Section -->
      <div class="settings-section">
        <div class="section-title">Personal Information</div>
        <div class="form-row">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input type="text" id="fullName" placeholder="Enter your full name" />
          </div>
          <div class="form-group">
            <label for="dateOfBirth">Date of Birth</label>
            <input type="date" id="dateOfBirth" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="your.email@example.com" required />
            <div class="helper-text">We'll send important updates to this email</div>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" placeholder="10-digit mobile number" maxlength="10" pattern="[0-9]{10}" />
            <div class="helper-text">Used for order notifications</div>
          </div>
        </div>
      </div>

      <!-- Location Information Section -->
      <div class="settings-section">
        <div class="section-title">Location</div>
        <div class="form-row">
          <div class="form-group">
            <label for="pincode">Default Pincode</label>
            <input type="text" id="pincode" placeholder="6-digit pincode" maxlength="6" pattern="[0-9]{6}" required />
            <div class="helper-text">Used for checking product availability</div>
          </div>
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" placeholder="Your city" />
          </div>
        </div>
      </div>

      <!-- Change Password Section -->
      <div class="settings-section">
        <div class="section-title">Change Password</div>
        <div class="form-row">
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" placeholder="Enter current password" />
            <div class="helper-text">Leave blank if you don't want to change</div>
          </div>
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password" />
            <div class="helper-text">Minimum 6 characters</div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" placeholder="Re-enter new password" />
          </div>
          <div class="form-group"></div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="save-btn">Save Changes</button>
        <button type="button" class="cancel-btn" onclick="resetForm()">Cancel</button>
      </div>
    </form>
  </div>

  <script src="backend-integration.js"></script>
  <script>
    let originalUserData = {};

    // Get current user from localStorage
    function getCurrentUser() {
      try {
        const userStr = localStorage.getItem('user');
        return userStr ? JSON.parse(userStr) : null;
      } catch (e) {
        console.error('Error parsing user from localStorage:', e);
        return null;
      }
    }

    function toggleAccount() {
      const dropdown = document.getElementById('accountDropdown');
      dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
    }

    function logout() {
      window.QuickKartAPI.apiLogout();
      window.location.href = 'login.html';
    }

    window.performSearch = function() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (!searchTerm) return;
      const user = getCurrentUser();
      if (user && user.role === 'VENDOR') {
        window.location.href = `vendor.html?search=${encodeURIComponent(searchTerm)}`;
      } else {
        window.location.href = `customer.html?search=${encodeURIComponent(searchTerm)}`;
      }
    }

    function showMessage(message, isError = false) {
      const successMsg = document.getElementById('successMsg');
      const errorMsg = document.getElementById('errorMsg');
      
      if (isError) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
        setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
      } else {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
        setTimeout(() => { successMsg.style.display = 'none'; }, 5000);
      }
      
      // Scroll to top to show message
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function loadUserSettings() {
      const user = getCurrentUser();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Show My Account menu
      document.getElementById('accountMenu').style.display = 'block';

      // Fetch full user details from backend
      const res = await window.QuickKartAPI.apiGetUser(user.username);
      if (res && res.success && res.data) {
        originalUserData = res.data;
        populateForm(res.data);
      } else {
        // Fallback to localStorage user
        originalUserData = user;
        populateForm(user);
      }
    }

    function populateForm(user) {
      if (!user) {
        console.error('User data is null or undefined');
        return;
      }
      // Account Information (readonly)
      document.getElementById('displayUsername').textContent = user.username || 'N/A';
      document.getElementById('displayRole').textContent = user.role === 'VENDOR' ? 'Vendor Account' : 'Customer Account';
      document.getElementById('rolebadge').textContent = user.role || 'USER';

      // Personal Information
      document.getElementById('fullName').value = user.fullName || user.name || '';
      document.getElementById('dateOfBirth').value = user.dateOfBirth || '';
      document.getElementById('email').value = user.email || '';
      document.getElementById('phone').value = user.phone || '';

      // Location
      document.getElementById('pincode').value = user.pincode || '';
      document.getElementById('city').value = user.city || '';

      // Password fields remain empty
    }

    function resetForm() {
      populateForm(originalUserData);
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      showMessage('Changes cancelled', false);
    }

    // Form submission - wrapped in DOMContentLoaded at bottom
    function initFormSubmission() {
      const form = document.getElementById('settingsForm');
      if (!form) {
        console.error('Settings form not found');
        return;
      }
      form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const user = getCurrentUser();
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Validate password change if attempted
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      if (currentPassword || newPassword || confirmPassword) {
        if (!currentPassword) {
          showMessage('Please enter your current password to change it', true);
          return;
        }
        if (!newPassword || newPassword.length < 6) {
          showMessage('New password must be at least 6 characters', true);
          return;
        }
        if (newPassword !== confirmPassword) {
          showMessage('New passwords do not match', true);
          return;
        }
      }

      // Validate email
      const email = document.getElementById('email').value.trim();
      if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showMessage('Please enter a valid email address', true);
        return;
      }

      // Validate pincode
      const pincode = document.getElementById('pincode').value.trim();
      if (!pincode || !pincode.match(/^[0-9]{6}$/)) {
        showMessage('Please enter a valid 6-digit pincode', true);
        return;
      }

      // Validate phone if provided
      const phone = document.getElementById('phone').value.trim();
      if (phone && !phone.match(/^[0-9]{10}$/)) {
        showMessage('Please enter a valid 10-digit phone number', true);
        return;
      }

      // Prepare update data
      const updateData = {
        fullName: document.getElementById('fullName').value.trim(),
        dateOfBirth: document.getElementById('dateOfBirth').value,
        email: email,
        phone: phone,
        pincode: pincode,
        city: document.getElementById('city').value.trim()
      };

      // Add password if changing
      if (currentPassword && newPassword) {
        updateData.currentPassword = currentPassword;
        updateData.newPassword = newPassword;
      }

      // Call backend API to update user
      const res = await window.QuickKartAPI.apiUpdateUser(user.username, updateData);

      if (res && res.success) {
        showMessage('Settings updated successfully!', false);
        
        // Update localStorage with new data
        const userRes = await window.QuickKartAPI.apiGetUser(user.username);
        if (userRes && userRes.success) {
          localStorage.setItem('user', JSON.stringify(userRes.data));
          originalUserData = userRes.data;
        }

        // Clear password fields
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } else {
        showMessage(res.error || 'Failed to update settings. Please try again.', true);
      }
      });
    }

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserSettings();
      initFormSubmission();
    });

    // Close dropdown when clicking outside
    window.addEventListener('click', (event) => {
      if (!event.target.matches('.account-menu button') && !event.target.closest('.account-dropdown')) {
        const dropdown = document.getElementById('accountDropdown');
        if (dropdown) dropdown.style.display = 'none';
      }
    });
  </script>
</body>
</html>
